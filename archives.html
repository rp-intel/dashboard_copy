<!DOCTYPE HTML>
<html>
<head>
  <title>RP Intel Archives Page</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    body { font-family: 'Open Sans Condensed', sans-serif; margin: 0; padding: 0; }
    #content { min-height: 100vh; }
    .search-bar-container{position:sticky;top:0;z-index:1000;background:#fff;padding:.2em 1.5em .3em;border-bottom:1px solid #ddd;display:flex;justify-content:flex-end;margin-top:-.3em}
    .search-bar-container input{width:220px;padding:.4em 1em;font-size:.95em;border:1px solid #ccc;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:box-shadow .2s}
    .search-bar-container input:focus{outline:none;box-shadow:0 0 5px rgba(0,0,0,.2)}
    details summary{cursor:pointer;font-size:1.1em;color:#2c2c2c;padding:.3em 0}
    #backToTopBtn{position:fixed;bottom:20px;right:30px;z-index:999;background:#2c2c2c;color:#fff;border:none;padding:10px 15px;font-size:14px;border-radius:999px;cursor:pointer;display:none}
    #backToTopBtn:hover{background:#444}
  </style>
</head>
<body class="is-preload page-archives">
<!--  sidebar (unchanged)  -->
<div id="sidebar">
  <h1 id="logo"><a href="#">RP Intel</a></h1>
  <nav id="nav"><ul>
    <li><a id="latest-updates-link">Latest Updates</a></li>
    <li class="current"><a id="archives-link" href="#">Archives</a></li>
    <li><a href="mailto:redconproperties.eg@gmail.com">Contact</a></li>
  </ul></nav>
  <section class="box text-style1"><div class="inner">
    <p><strong>RP Intel</strong><br>Your personal intelligence system designed to keep you informed</p>
  </div></section>
</div>

<!-- content -->
<div id="content"><div class="inner">
  <article class="box post post-excerpt">
    <header>
      <div class="brand-badge" style="position:absolute;top:0;right:0;padding:10px 15px;color:#444;display:flex;flex-direction:column;align-items:flex-start">
        <p style="font-size:.9rem;margin:0 0 4px"><strong>Powered by</strong></p>
        <img src="images/rp_logo.png" alt="Redcon Properties Logo" style="height:24px;opacity:.9">
      </div>
      <h2 id="latest-heading">Archives</h2>
    </header>
    <div class="search-bar-container"><input id="searchInput" placeholder="Search headlines or dates..."></div>
    <div id="archive-content"></div>
  </article>
</div></div>

<button onclick="scrollToTop()" id="backToTopBtn" title="Back to top">↑ Top</button>

<script src="assets/js/jquery.min.js"></script><script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script><script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
/* ---------- helpers ---------- */
function decrypt(cipherText, password){
  try{const bytes=CryptoJS.AES.decrypt(cipherText,password);return bytes.toString(CryptoJS.enc.Utf8);}catch(e){console.error("decrypt",e);return""}}
function formatMarkdown(t){return t.replace(/\*\*(.*?):\*\*/g,"<strong>$1</strong>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>")}
async function fetchDecryptMerge(urls,password,asObject){
  const merged=asObject?{}:[];for(const u of urls){try{const txt=await(await fetch(u)).text();const data=JSON.parse(decrypt(txt,password)||"{}");if(asObject){for(const[k,v]of Object.entries(data)){merged[k]=(merged[k]||[]).concat(v)}}else merged.push(...data);}catch(e){console.warn("skip shard",u,e)}}
  return merged;
}

/* ---------- main ---------- */
async function decryptAndDisplay(){
  const params=new URLSearchParams(location.search),password=params.get("key"),userId=params.get("user");
  if(!password||!userId)return;
  const keyP=encodeURIComponent(password),userP=encodeURIComponent(userId);
  document.getElementById("archives-link").href=`archives.html?key=${keyP}&user=${userP}`;
  document.getElementById("latest-updates-link").href=`index.html?key=${keyP}&user=${userP}`;

  try{
    /* 1. fetch index of shard URLs */
    const idx=await (await fetch("shard_index.json")).json();
    const allData = await fetchDecryptMerge(idx.all||[],  password, true);
    const userMap = await fetchDecryptMerge(idx.user||[], password, true); // object keyed by date?→false if list

    const userArticles=userMap[userId]||[];
    const wanted=new Map();userArticles.forEach(a=>{const[t,b]=Object.entries(a)[0];wanted.set(t.trim(),typeof b==="string"?b.trim():b)});

    const container=document.getElementById("archive-content");container.innerHTML="";
    for(const[date,articleList]of Object.entries(allData)){
      const matched=[];
      articleList.forEach(group=>{
        Object.entries(group).forEach(([title,content])=>{
          const t=title.trim(),c=typeof content==="string"?content.trim():content;
          if(wanted.has(t)&&wanted.get(t)===c)matched.push({title:t,content:c});
        });
      });
      if(!matched.length)continue;
      const h3=document.createElement("h3");h3.innerText=date;h3.style.color="#2c2c2c";container.appendChild(h3);
      matched.forEach(({title,content})=>{
        const det=document.createElement("details"),sum=document.createElement("summary");sum.innerText=title;
        const p=document.createElement("p");p.innerHTML=formatMarkdown(content);
        det.appendChild(sum);det.appendChild(p);container.appendChild(det);
      });
    }

    /* search filter unchanged */
    document.getElementById("searchInput").addEventListener("input",()=>{
      const kw=document.getElementById("searchInput").value.trim().toLowerCase();
      const headings=container.querySelectorAll("h3"),details=container.querySelectorAll("details");
      if(!kw){headings.forEach(h=>h.style.display="block");details.forEach(d=>d.style.display="block");return;}
      headings.forEach(h=>h.style.display="none");details.forEach(d=>d.style.display="none");
      details.forEach(d=>{
        const headline=d.querySelector("summary").innerText.toLowerCase();
        let dateNode=d.previousElementSibling;while(dateNode&&dateNode.tagName!=="H3")dateNode=dateNode.previousElementSibling;
        const dateTxt=dateNode?dateNode.innerText.toLowerCase():"";
        if(headline.includes(kw)||dateTxt.includes(kw)){d.style.display="block";if(dateNode)dateNode.style.display="block";}
      });
    });

  }catch(e){console.error("load archive",e);}
}

/* ---------- misc ---------- */
window.onscroll=function(){document.getElementById("backToTopBtn").style.display=(document.documentElement.scrollTop>200)?"block":"none"}
function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}
window.addEventListener("DOMContentLoaded",decryptAndDisplay);
</script>
</body>
</html>
