<!DOCTYPE HTML>
<html>
<head>
  <title>RP Intel Archives Page</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    body{font-family:'Open Sans Condensed',sans-serif;margin:0;padding:0} #content{min-height:100vh}
    .search-bar-container{position:sticky;top:0;z-index:1000;background:#fff;padding:.2em 1.5em .3em;border-bottom:1px solid #ddd;display:flex;justify-content:flex-end;margin-top:-.3em}
    .search-bar-container input{width:220px;padding:.4em 1em;font-size:.95em;border:1px solid #ccc;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);}
    .search-bar-container input:focus{outline:none;box-shadow:0 0 5px rgba(0,0,0,.2)}
    details summary{cursor:pointer;font-size:1.1em;color:#2c2c2c;padding:.3em 0}
    #backToTopBtn{position:fixed;bottom:20px;right:30px;z-index:999;background:#2c2c2c;color:#fff;border:none;padding:10px 15px;font-size:14px;border-radius:999px;cursor:pointer;display:none}
    #backToTopBtn:hover{background:#444}
  </style>
</head>
<body class="is-preload page-archives">
<!-- Sidebar (unchanged) -->
<div id="sidebar">
  <h1 id="logo"><a href="#">RP Intel</a></h1>
  <nav id="nav">
    <ul>
      <li><a id="latest-updates-link">Latest Updates</a></li>
      <li class="current"><a id="archives-link" href="#">Archives</a></li>
      <li><a href="mailto:redconproperties.eg@gmail.com">Contact</a></li>
    </ul>
  </nav>
  <section class="box text-style1"><div class="inner">
    <p><strong>RP Intel</strong><br>Your personal intelligence system designed to keep you informed</p>
  </div></section>
</div>

<!-- Content -->
<div id="content"><div class="inner">
  <article class="box post post-excerpt">
    <header>
      <div class="brand-badge" style="position:absolute;top:0;right:0;padding:10px 15px;color:#444;display:flex;flex-direction:column;align-items:flex-start">
        <p style="font-size:.9rem;margin:0 0 4px"><strong>Powered by</strong></p>
        <img src="images/rp_logo.png" alt="Redcon Properties Logo" style="height:24px;opacity:.9">
      </div>
      <h2 id="latest-heading">Archives</h2>
    </header>

    <!-- Sticky search bar -->
    <div class="search-bar-container">
      <input type="text" id="searchInput" placeholder="Search headlines or dates...">
    </div>

    <div id="archive-content"></div>
  </article>
</div></div>

<button onclick="scrollToTop()" id="backToTopBtn" title="Back to top">↑ Top</button>

<!-- Dependencies -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
/* ---------------- helpers ---------------- */
function decrypt(cipherText, password){
  try{const bytes=CryptoJS.AES.decrypt(cipherText, password);return bytes.toString(CryptoJS.enc.Utf8);}catch(e){console.error("decrypt‑err",e);return"";}
}
function formatMarkdown(t){
  return t.replace(/\*\*(.*?):\*\*/g,"<strong>$1</strong>")
          .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
          .replace(/\n\n/g,"<br><br>")
          .replace(/\n/g,"<br>");
}
/* Fetch a list of URLs, decrypt, merge */
async function fetchDecryptMerge(urls, password, asObject=true){
  const merged = asObject ? {} : [];
  for(const u of urls){
    try{
      const txt = await (await fetch(u)).text();
      const json = JSON.parse(decrypt(txt, password) || (asObject ? "{}" : "[]"));
      if(asObject){
        for(const [k,v] of Object.entries(json)){
          merged[k] = (merged[k]||[]).concat(v);
        }
      }else merged.push(...json);
    }catch(e){console.warn("Skip shard:", u, e);}
  }
  return merged;
}

/* ---------------- main workflow ---------------- */
async function decryptAndDisplay(){
  const qs = new URLSearchParams(location.search);
  const password = qs.get("key"), userId = qs.get("user");
  if(!password || !userId) return;

  /* update sidebar links with same creds */
  const qp = `?key=${encodeURIComponent(password)}&user=${encodeURIComponent(userId)}`;
  document.getElementById("archives-link").href      = `archives.html${qp}`;
  document.getElementById("latest-updates-link").href = `index.html${qp}`;

  try{
    /* 1. fetch index listing every shard URL */
    const idxResp = await fetch("shard_index.json");
    if(!idxResp.ok) throw new Error("Cannot load shard_index.json ("+idxResp.status+")");
    const idx = await idxResp.json();

    /* 2. download & merge all shards */
    const [allData, userMap] = await Promise.all([
      fetchDecryptMerge(idx.all  || [], password, true),
      fetchDecryptMerge(idx.user || [], password, true)
    ]);

    const userArticles = userMap[userId] || [];
    const wanted = new Map();
    userArticles.forEach(obj=>{
      const [title, body] = Object.entries(obj)[0];
      wanted.set(title.trim(), typeof body==="string"?body.trim():body);
    });

    const container = document.getElementById("archive-content");
    container.innerHTML = "";

    /* 3. render (unchanged) */
    for(const [date, articleArr] of Object.entries(allData)){
      const matched = [];
      articleArr.forEach(group=>{
        for(const [title, content] of Object.entries(group)){
          const t = title.trim();
          const c = typeof content==="string"?content.trim():content;
          if(wanted.has(t) && wanted.get(t)===c) matched.push({title:t, content:c});
        }
      });
      if(!matched.length) continue;

      const h3 = document.createElement("h3");
      h3.textContent = date;
      h3.style.color="#2c2c2c";
      container.appendChild(h3);

      matched.forEach(({title, content})=>{
        const det=document.createElement("details");
        const sum=document.createElement("summary");
        sum.textContent=title;
        const p=document.createElement("p");
        p.innerHTML = formatMarkdown(content);
        det.appendChild(sum); det.appendChild(p);
        container.appendChild(det);
      });
    }

    /* search bar (unchanged) */
    document.getElementById("searchInput").addEventListener("input", e=>{
      const kw = e.target.value.trim().toLowerCase();
      const headings = container.querySelectorAll("h3");
      const details  = container.querySelectorAll("details");
      if(!kw){headings.forEach(h=>h.style.display="block");details.forEach(d=>d.style.display="block");return;}
      headings.forEach(h=>h.style.display="none");details.forEach(d=>d.style.display="none");
      details.forEach(d=>{
        const head = d.querySelector("summary").innerText.toLowerCase();
        let dateNode = d.previousElementSibling;
        while(dateNode && dateNode.tagName!=="H3") dateNode = dateNode.previousElementSibling;
        const dateText = dateNode ? dateNode.innerText.toLowerCase() : "";
        if(head.includes(kw)||dateText.includes(kw)){
          d.style.display="block"; if(dateNode) dateNode.style.display="block";
        }
      });
    });

  }catch(err){console.error("Archive‑load error:", err);}
}

/* UI */
window.onscroll = ()=>{document.getElementById("backToTopBtn").style.display = document.documentElement.scrollTop>200 ? "block":"none";}
function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"})}
window.addEventListener("DOMContentLoaded", decryptAndDisplay);
</script>
</body>
</html>
