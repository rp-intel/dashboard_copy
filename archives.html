<!DOCTYPE HTML>
<html>
<head>
  <title>RP Intel Archives Page</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="assets/css/main.css" />
  <style>
    body { font-family: 'Open Sans Condensed', sans-serif; margin: 0; padding: 0; }
    #content { min-height: 100vh; }
    .search-bar-container{position:sticky;top:0;z-index:1000;background:#fff;padding:.2em 1.5em .3em;border-bottom:1px solid #ddd;display:flex;justify-content:flex-end;margin-top:-.3em}
    .search-bar-container input{width:220px;padding:.4em 1em;font-size:.95em;border:1px solid #ccc;border-radius:999px;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.1);transition:box-shadow .2s}
    .search-bar-container input:focus{outline:none;box-shadow:0 0 5px rgba(0,0,0,.2)}
    details summary{cursor:pointer;font-size:1.1em;color:#2c2c2c;padding:.3em 0}
    #backToTopBtn{position:fixed;bottom:20px;right:30px;z-index:999;background:#2c2c2c;color:#fff;border:none;padding:10px 15px;font-size:14px;border-radius:999px;cursor:pointer;display:none}
    #backToTopBtn:hover{background:#444}
  </style>
</head>

<body class="is-preload page-archives">

<!-- Sidebar ------------------------------------------------------------->
<div id="sidebar">
  <h1 id="logo"><a href="#">RP Intel</a></h1>
  <nav id="nav">
    <ul>
      <li><a id="latest-updates-link">Latest Updates</a></li>
      <li class="current"><a id="archives-link" href="#">Archives</a></li>
      <li><a href="mailto:redconproperties.eg@gmail.com">Contact</a></li>
    </ul>
  </nav>
  <section class="box text-style1"><div class="inner">
    <p><strong>RP Intel</strong><br>Your personal intelligence system designed to keep you informed</p>
  </div></section>
  <ul id="copyright"><li>&copy; Design: <a href="http://html5up.net">HTML5 UP</a></li></ul>
</div>

<!-- Content ------------------------------------------------------------->
<div id="content">
  <div class="inner">
    <article class="box post post-excerpt">
      <header>
        <div class="brand-badge"
             style="position:absolute;top:0;right:0;padding:10px 15px;font-family:'Open Sans Condensed',sans-serif;color:#444;text-align:left;display:flex;flex-direction:column;align-items:flex-start;">
          <p style="font-size:.9rem;margin:0 0 4px"><strong>Powered by</strong></p>
          <img src="images/rp_logo.png" alt="Redcon Properties Logo" style="height:24px;opacity:.9">
        </div>
        <h2 id="latest-heading">Archives</h2>
      </header>

      <!-- Sticky search bar -->
      <div class="search-bar-container">
        <input type="text" id="searchInput" placeholder="Search headlines or dates…">
      </div>

      <!-- Articles injected here -->
      <div id="archive-content"></div>
    </article>
  </div>
</div>

<button onclick="scrollToTop()" id="backToTopBtn" title="Back to top">↑ Top</button>

<!-- Libraries -->
<script src="assets/js/jquery.min.js"></script>
<script src="assets/js/browser.min.js"></script>
<script src="assets/js/breakpoints.min.js"></script>
<script src="assets/js/util.js"></script>
<script src="assets/js/main.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<script>
/* -------- crypto & helpers ------------------------------------- */
function decrypt(cipherText, password) {
  try { return CryptoJS.AES.decrypt(cipherText, password).toString(CryptoJS.enc.Utf8); }
  catch (e) { console.error("decrypt error", e); return "{}"; }
}
function formatMarkdown(t){
  return t.replace(/\*\*(.*?):\*\*/g,"<strong>$1</strong>")
          .replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>")
          .replace(/\n\n/g,"<br><br>").replace(/\n/g,"<br>");
}

/* -------- main ------------------------------------------------- */
async function decryptAndDisplay(){
  const params   = new URLSearchParams(location.search);
  const password = params.get("key");
  const userId   = params.get("user");
  if(!password||!userId) return;

  /* keep creds in sidebar links */
  const keyQ = encodeURIComponent(password), userQ = encodeURIComponent(userId);
  document.getElementById("archives-link").href       = `archives.html?key=${keyQ}&user=${userQ}`;
  document.getElementById("latest-updates-link").href = `index.html?key=${keyQ}&user=${userQ}`;

  try{
    /* 1️⃣ fetch shard index --------------------------------------- */
    const indexObj = await (await fetch("shard_index.json")).json();
    const allUrls  = indexObj.all  || [];
    const userUrls = indexObj.user || [];

    /* 2️⃣ download + merge every shard ---------------------------- */
    const allData = {};
    for(const url of allUrls){
      const txt = await (await fetch(url)).text();
      Object.assign(allData, JSON.parse(decrypt(txt,password)));
    }

    const userMap = {};
    for(const url of userUrls){
      const txt = await (await fetch(url)).text();
      Object.assign(userMap, JSON.parse(decrypt(txt,password)));
    }

    const userArticles = userMap[userId] || [];

    /* build fast lookup of wanted {title → body} */
    const wanted = new Map();
    userArticles.forEach(a=>{
      const [title, body] = Object.entries(a)[0];
      wanted.set(title.trim(), typeof body==="string"?body.trim():body);
    });

    /* 3️⃣ render -------------------------------------------------- */
    const container = document.getElementById("archive-content");
    container.innerHTML="";

    Object.entries(allData).forEach(([date, list])=>{
      const matches=[];
      list.forEach(group=>{
        Object.entries(group).forEach(([title,content])=>{
          const t=title.trim();
          const c=typeof content==="string"?content.trim():content;
          if(wanted.has(t)&&wanted.get(t)===c) matches.push({title:t,content:c});
        });
      });
      if(matches.length){
        const h=document.createElement("h3");
        h.innerText=date; h.style.color="#2c2c2c"; container.appendChild(h);
        matches.forEach(({title,content})=>{
          const d=document.createElement("details");
          const s=document.createElement("summary"); s.innerText=title;
          const p=document.createElement("p"); p.innerHTML=formatMarkdown(content);
          d.appendChild(s); d.appendChild(p); container.appendChild(d);
        });
      }
    });

    /* 4️⃣ search filter ------------------------------------------ */
    document.getElementById("searchInput").addEventListener("input", e=>{
      const kw=e.target.value.trim().toLowerCase();
      const heads=[...container.querySelectorAll("h3")];
      const details=[...container.querySelectorAll("details")];

      if(!kw){heads.forEach(h=>h.style.display="block");details.forEach(d=>d.style.display="block");return;}

      heads.forEach(h=>h.style.display="none");details.forEach(d=>d.style.display="none");

      details.forEach(d=>{
        const headline=d.querySelector("summary").innerText.toLowerCase();
        let dateNode=d.previousElementSibling;
        while(dateNode&&dateNode.tagName!=="H3") dateNode=dateNode.previousElementSibling;
        const dateText=dateNode?dateNode.innerText.toLowerCase():"";
        if(headline.includes(kw)||dateText.includes(kw)){
          d.style.display="block";
          if(dateNode) dateNode.style.display="block";
        }
      });
    });

  }catch(err){console.error("archive load error",err);}
}

/* back‑to‑top */
window.onscroll = ()=>{document.getElementById("backToTopBtn").style.display =
  document.documentElement.scrollTop>200?"block":"none";};
function scrollToTop(){window.scrollTo({top:0,behavior:"smooth"});}

window.addEventListener("DOMContentLoaded", decryptAndDisplay);
</script>
</body>
</html>
